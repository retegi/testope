{% extends 'home/base_sin_menu_sin_footer.html' %}
{% load i18n %}
{% load static %}

{% block head %}
<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
{% endblock %}

{% block contenido %}
<div class="container-fluid">
    <div class="row">
        <div class="col-2"></div>
        <div class="col-8 p-5" style="position:relative;">
            <a href="{% url 'home_app:home' %}" class="" style="position:fixed;">
                <button class="btn bg-light">Volver</button>
            </a>








<h1 class="text-center display-6 col-lg-12 col-md-12">{{ test.category }}</h1>

<!-- Pregunta -->
<h3 class="text-center">{{ currentQuestion }}/{{ totalQuestions }}</h3>
<div>
    <p class="display-6 col-lg-12 col-md-12" id="questionText">{{ test.number }}.- {{ test.question }}</p>
</div>

<div id="answersContainer" class="d-flex flex-column">
    <!-- Las respuestas se generarán dinámicamente -->
</div>

<!-- Botón "Siguiente" inicialmente oculto -->
<div id="nextButtonContainer" class="mt-4 text-center" style="display: none;">
    <form method="get" action="{% url 'learning_app:next_question' category.id currentQuestion|add:1 %}">
        <button type="submit" class="btn btn-secondary" id="nextButton">Siguiente</button>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const answersContainer = document.getElementById("answersContainer");
        const nextButtonContainer = document.getElementById("nextButtonContainer");
        const nextButton = document.getElementById("nextButton");
        const questionText = document.getElementById("questionText");

        // Respuestas originales de la plantilla
        const answers = [
            { text: "{{ test.aAnswer }}", value: "A" },
            { text: "{{ test.bAnswer }}", value: "B" },
            { text: "{{ test.cAnswer }}", value: "C" },
            { text: "{{ test.dAnswer }}", value: "D" },
        ];

        // Obtener la respuesta correcta del backend
        const correctAnswer = "{{ test.correctAnswer }}".trim(); // La letra correcta

        // Barajar las respuestas
        const shuffledAnswers = answers.sort(() => Math.random() - 0.5);

        // Crear los botones de respuestas
        const buttons = [];
        shuffledAnswers.forEach((answer, index) => {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "btn btn-primary text-start mb-2";
            button.innerHTML = answer.text;
            button.dataset.value = answer.value;
            button.dataset.index = index + 1; // Para asociar con la tecla
            button.addEventListener("click", () => submitAnswer(button));
            answersContainer.appendChild(button);
            buttons.push(button);
        });

        // Manejar la selección de respuestas
        function submitAnswer(selectedButton) {
            const userAnswer = selectedButton.dataset.value; // Respuesta seleccionada por el usuario

            // Deshabilitar todos los botones
            buttons.forEach(button => button.disabled = true);

            // Validar la respuesta seleccionada
            if (userAnswer === correctAnswer) {
                selectedButton.classList.replace("btn-primary", "btn-success"); // Correcto
            } else {
                selectedButton.classList.replace("btn-primary", "btn-danger"); // Incorrecto

                // Mostrar la respuesta correcta en verde
                buttons.forEach(button => {
                    if (button.dataset.value === correctAnswer) {
                        button.classList.replace("btn-primary", "btn-success");
                    }
                });
            }

            // Mostrar el botón "Siguiente"
            nextButtonContainer.style.display = "block";
        }

        // Manejar eventos de teclado
        document.addEventListener("keydown", (event) => {
            const key = event.key.toLowerCase();

            if (key >= "1" && key <= "4") {
                const buttonIndex = parseInt(key) - 1;
                if (buttons[buttonIndex]) {
                    buttons[buttonIndex].click();
                }
            } else if (["a", "b", "c", "d"].includes(key)) {
                const buttonMap = { a: 0, b: 1, c: 2, d: 3 };
                const buttonIndex = buttonMap[key];
                if (buttons[buttonIndex]) {
                    buttons[buttonIndex].click();
                }
            } else if (key === "enter" && nextButtonContainer.style.display === "block") {
                nextButton.click();
            } else if (key === "º") {
                speakQuestion();
            }
        });

        // Función para reproducir el texto de la pregunta
        function speakQuestion() {
            const utterance = new SpeechSynthesisUtterance(questionText.innerText);
            speechSynthesis.speak(utterance);
        }
    });
</script>
















            <!-- Modal de Bootstrap -->
            <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="resultModalLabel">Resultado</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Este mensaje se actualiza dinámicamente -->
                            <p id="result-message"></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" id="confirm-next-question" data-bs-dismiss="modal">Aceptar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Progreso -->


        <div class="col-2 bg-light border pl-1 pr-1" style="height:100vh;">
            <h3 class="text-center">Social</h3>
            <p style="color: black; background-color:pink;"><b>Último donativo:<br>Olvin Daniel (Donostia): </b>¡Mucha suerte y ánimo a todos!</p>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}

